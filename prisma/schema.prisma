generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 0. ACCESS CONTROL & USERS
// ==========================================

enum RoleType {
  SUPER_ADMIN
  ADMIN
  TECHNICIAN
}

model Role {
  role_id   Int      @id @default(autoincrement())
  role_name RoleType @unique

  users User[]

  @@map("roles")
}

model User {
  user_id       Int      @id @default(autoincrement())
  username      String   @unique
  full_name     String?
  email         String   @unique
  password_hash String
  image_url     String?
  role_id       Int
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  role Role @relation(fields: [role_id], references: [role_id])

  // Tracking Relations
  created_meters            Meter[]               @relation("MeterCreatedBy")
  updated_meters            Meter[]               @relation("MeterUpdatedBy")
  created_tank_profiles     TankProfile[]         @relation("ProfileCreatedBy")
  updated_tank_profiles     TankProfile[]         @relation("ProfileUpdatedBy")
  created_reading_configs   MeterReadingConfig[]  @relation("ConfigCreatedBy")
  updated_reading_configs   MeterReadingConfig[]  @relation("ConfigUpdatedBy")
  created_calc_templates    CalculationTemplate[] @relation("TemplateCreatedBy")
  updated_calc_templates    CalculationTemplate[] @relation("TemplateUpdatedBy")
  created_price_schemes     PriceScheme[]         @relation("SchemeCreatedBy")
  updated_price_schemes     PriceScheme[]         @relation("SchemeUpdatedBy")
  created_tenants           Tenant[]              @relation("TenantCreatedBy")
  updated_tenants           Tenant[]              @relation("TenantUpdatedBy")
  created_locations         Location[]            @relation("LocationCreatedBy")
  updated_locations         Location[]            @relation("LocationUpdatedBy")
  created_lifecycle_logs    MeterLifecycleLog[]   @relation("LogCreatedBy")
  technician_lifecycle_logs MeterLifecycleLog[]   @relation("TechnicianAssigned")
  created_budgets           AnnualBudget[]        @relation("BudgetCreatedBy")
  updated_budgets           AnnualBudget[]        @relation("BudgetUpdatedBy")
  created_efficiency_targets EfficiencyTarget[]   @relation("TargetCreatedBy")

  captured_reading_sessions ReadingSession[]
  notifications             Notification[]
  audit_logs                AuditLog[]

  @@map("users")
}

// ==========================================
// 1. MASTER: ENERGY & READING TYPES
// ==========================================

model EnergyType {
  energy_type_id Int    @id @default(autoincrement())
  name           String @unique // Electricity, Water, Fuel
  unit_standard  String

  meters         Meter[]
  annual_budgets AnnualBudget[]
  reading_types  ReadingType[] // Relasi balik ke tipe pembacaan

  @@map("energy_types")
}

model ReadingType {
  reading_type_id Int    @id @default(autoincrement())
  energy_type_id  Int
  type_name       String // WBP, LWBP, Flow Rate, Level
  unit            String // kWh, cm, Celcius

  energy_type EnergyType @relation(fields: [energy_type_id], references: [energy_type_id],  onDelete: Cascade)

  // Relations
  meter_configs   MeterReadingConfig[]
  reading_details ReadingDetail[]
  scheme_rates    SchemeRate[]

  @@unique([type_name, energy_type_id])
  @@map("reading_types")
}

// ==========================================
// 2. BUSINESS: TENANT & LOCATION
// ==========================================

model Tenant {
  tenant_id      Int      @id @default(autoincrement())
  name           String   @unique
  category       String?  // Airline, Retail, Office
  contact_person String?
  phone          String?
  email          String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  created_by     Int?
  updated_by     Int?

  creator User?   @relation("TenantCreatedBy", fields: [created_by], references: [user_id])
  updater User?   @relation("TenantUpdatedBy", fields: [updated_by], references: [user_id])
  meters  Meter[]

  @@map("tenants")
}

model Location {
  location_id Int      @id @default(autoincrement())
  name        String
  parent_id   Int?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  created_by  Int?
  updated_by  Int?

  parent   Location?  @relation("LocHierarchy", fields: [parent_id], references: [location_id])
  children Location[] @relation("LocHierarchy")
  creator  User?      @relation("LocationCreatedBy", fields: [created_by], references: [user_id])
  updater  User?      @relation("LocationUpdatedBy", fields: [updated_by], references: [user_id])

  meters   Meter[]
  pax_data PaxData[]

  @@map("locations")
}

// ==========================================
// 3. METER ASSET MANAGEMENT
// ==========================================

enum MeterStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

model Meter {
  meter_id                Int         @id @default(autoincrement())
  meter_code              String      @unique
  serial_number           String?
  name                    String?
  tenant_id               Int?
  location_id             Int?
  calculation_template_id String?
  price_scheme_id         Int?
  energy_type_id          Int
  status                  MeterStatus @default(ACTIVE)
  is_virtual              Boolean     @default(false)
  
  // Spesifikasi Alat (Langsung di tabel Meter)
  multiplier     Decimal  @default(1.0) @db.Decimal(10, 4)
  allow_gap      Boolean  @default(false)
  allow_decrease Boolean  @default(false)
  rollover_limit Decimal? @db.Decimal(19, 4)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  created_by Int?
  updated_by Int?

  // Relations
  energy_type          EnergyType           @relation(fields: [energy_type_id], references: [energy_type_id])
  tenant               Tenant?              @relation(fields: [tenant_id], references: [tenant_id])
  location             Location?            @relation(fields: [location_id], references: [location_id])
  calculation_template CalculationTemplate? @relation(fields: [calculation_template_id], references: [template_id])
  price_scheme         PriceScheme?         @relation(fields: [price_scheme_id], references: [scheme_id])
  creator              User?                @relation("MeterCreatedBy", fields: [created_by], references: [user_id])
  updater              User?                @relation("MeterUpdatedBy", fields: [updated_by], references: [user_id])

  reading_configs    MeterReadingConfig[]
  tank_profile       TankProfile?
  reading_sessions   ReadingSession[]
  daily_summaries    DailySummary[]
  lifecycle_logs     MeterLifecycleLog[]
  budget_allocations BudgetAllocation[]
  efficiency_targets EfficiencyTarget[]
  ml_predictions     MlPrediction[]

  @@index([tenant_id])
  @@index([location_id])
  @@index([status])
  @@map("meters")
}

model MeterReadingConfig {
  config_id           Int      @id @default(autoincrement())
  meter_id            Int
  reading_type_id     Int      // KEMBALI MENGGUNAKAN READING TYPE
  is_active           Boolean  @default(true)
  alarm_min_threshold Decimal? @db.Decimal(10, 2)
  alarm_max_threshold Decimal? @db.Decimal(10, 2)
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  created_by Int?
  updated_by Int?

  meter        Meter       @relation(fields: [meter_id], references: [meter_id], onDelete: Cascade)
  reading_type ReadingType @relation(fields: [reading_type_id], references: [reading_type_id])
  creator      User?       @relation("ConfigCreatedBy", fields: [created_by], references: [user_id])
  updater      User?       @relation("ConfigUpdatedBy", fields: [updated_by], references: [user_id])

  @@unique([meter_id, reading_type_id])
  @@map("meter_reading_configs")
}

enum TankShape {
  CYLINDER_VERTICAL
  CYLINDER_HORIZONTAL
  BOX
  SPHERE
  CUSTOM
}

model TankProfile {
  profile_id      Int        @id @default(autoincrement())
  meter_id        Int        @unique
  shape           TankShape?
  height_max_cm   Decimal    @db.Decimal(10, 2)
  length_cm       Decimal?   @db.Decimal(10, 2)
  width_cm        Decimal?   @db.Decimal(10, 2)
  diameter_cm     Decimal?   @db.Decimal(10, 2)
  capacity_liters Decimal    @db.Decimal(12, 2)
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  created_by Int?
  updated_by Int?

  meter   Meter @relation(fields: [meter_id], references: [meter_id], onDelete: Cascade)
  creator User? @relation("ProfileCreatedBy", fields: [created_by], references: [user_id])
  updater User? @relation("ProfileUpdatedBy", fields: [updated_by], references: [user_id])

  @@map("tank_profiles")
}

// ==========================================
// 4. TRANSACTIONAL & PAX DATA
// ==========================================

model ReadingSession {
  session_id          Int      @id @default(autoincrement())
  meter_id            Int
  reading_date        DateTime
  captured_by_user_id Int?
  evidence_image_url  String?
  notes               String?
  created_at          DateTime @default(now())

  meter           Meter           @relation(fields: [meter_id], references: [meter_id])
  captured_by     User?           @relation(fields: [captured_by_user_id], references: [user_id])
  details         ReadingDetail[]
  pax_records     PaxData[]
  ml_classifications MlClassification[]

  @@unique([meter_id, reading_date])
  @@index([reading_date])
  @@map("reading_sessions")
}

model ReadingDetail {
  detail_id       Int     @id @default(autoincrement())
  session_id      Int
  reading_type_id Int     // KEMBALI MENGGUNAKAN READING TYPE
  value           Decimal @db.Decimal(19, 4)

  session      ReadingSession @relation(fields: [session_id], references: [session_id], onDelete: Cascade)
  reading_type ReadingType    @relation(fields: [reading_type_id], references: [reading_type_id])

  @@map("reading_details")
}

model PaxData {
  pax_id      Int      @id @default(autoincrement())
  date        DateTime @db.Date
  pax_count   Int      @default(0)
  location_id Int?
  session_id  Int?
  
  created_at DateTime @default(now())

  location Location?       @relation(fields: [location_id], references: [location_id])
  session  ReadingSession? @relation(fields: [session_id], references: [session_id], onDelete: SetNull)

  @@unique([date, location_id, session_id])
  @@map("pax_data")
}

// ==========================================
// 5. FORMULA ENGINE
// ==========================================

model CalculationTemplate {
  template_id String   @id @default(uuid())
  name        String
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  created_by  Int?
  updated_by  Int?

  creator User? @relation("TemplateCreatedBy", fields: [created_by], references: [user_id])
  updater User? @relation("TemplateUpdatedBy", fields: [updated_by], references: [user_id])

  definitions FormulaDefinition[]
  meters      Meter[]

  @@map("calculation_templates")
}

model FormulaDefinition {
  def_id        String  @id @default(uuid())
  template_id   String
  name          String
  is_main       Boolean @default(false)
  formula_items Json    // Menyimpan metadata variabel (slug, timeShift, meterId)

  template CalculationTemplate @relation(fields: [template_id], references: [template_id], onDelete: Cascade)

  @@map("formula_definitions")
}

// ==========================================
// 6. MACHINE LEARNING MODULE
// ==========================================

enum MlModelType {
  PREDICTION
  CLASSIFICATION
  ANOMALY_DETECTION
}

model MlModel {
  model_id       String      @id @default(uuid())
  name           String
  version        String
  type           MlModelType @default(PREDICTION)
  description    String?
  accuracy_score Decimal?    @db.Decimal(5, 4)
  last_trained   DateTime?
  created_at     DateTime    @default(now())

  predictions     MlPrediction[]
  classifications MlClassification[]

  @@map("ml_models")
}

model MlPrediction {
  prediction_id   Int      @id @default(autoincrement())
  meter_id        Int
  model_id        String
  target_date     DateTime @db.Date
  predicted_value Decimal  @db.Decimal(19, 4)
  confidence_low  Decimal? @db.Decimal(19, 4)
  confidence_high Decimal? @db.Decimal(19, 4)
  created_at      DateTime @default(now())

  meter Meter   @relation(fields: [meter_id], references: [meter_id])
  model MlModel @relation(fields: [model_id], references: [model_id])

  @@unique([meter_id, model_id, target_date])
  @@map("ml_predictions")
}

model MlClassification {
  classification_id  Int      @id @default(autoincrement())
  model_id           String
  label              String   // "NORMAL", "ANOMALY", "LEAK"
  probability        Decimal  @db.Decimal(5, 4)
  is_verified        Boolean  @default(false)
  created_at         DateTime @default(now())

  reading_session_id Int?
  daily_summary_id   Int?

  model           MlModel         @relation(fields: [model_id], references: [model_id])
  reading_session ReadingSession? @relation(fields: [reading_session_id], references: [session_id])
  daily_summary   DailySummary?   @relation(fields: [daily_summary_id], references: [summary_id])

  @@map("ml_classifications")
}

// ==========================================
// 7. BILLING & REPORTING
// ==========================================

model PriceScheme {
  scheme_id      Int      @id @default(autoincrement())
  name           String
  description    String?
  effective_date DateTime @db.Date
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  created_by     Int?
  updated_by     Int?

  creator User? @relation("SchemeCreatedBy", fields: [created_by], references: [user_id])
  updater User? @relation("SchemeUpdatedBy", fields: [updated_by], references: [user_id])

  rates  SchemeRate[]
  meters Meter[]

  @@map("price_schemes")
}

model SchemeRate {
  rate_id         Int     @id @default(autoincrement())
  scheme_id       Int
  reading_type_id Int     // KEMBALI MENGGUNAKAN READING TYPE
  rate_value      Decimal @db.Decimal(19, 4)

  scheme       PriceScheme @relation(fields: [scheme_id], references: [scheme_id], onDelete: Cascade)
  reading_type ReadingType @relation(fields: [reading_type_id], references: [reading_type_id])

  @@map("scheme_rates")
}

model DailySummary {
  summary_id               Int      @id @default(autoincrement())
  meter_id                 Int
  summary_date             DateTime @db.Date
  total_usage              Decimal  @db.Decimal(19, 4)
  total_cost               Decimal  @db.Decimal(19, 4)
  used_formula_template_id String?
  calculated_at            DateTime @default(now())
  is_manual_override       Boolean  @default(false)

  meter              Meter              @relation(fields: [meter_id], references: [meter_id])
  summary_details    SummaryDetail[]
  ml_classifications MlClassification[]

  @@unique([meter_id, summary_date])
  @@map("daily_summaries")
}

model SummaryDetail {
  id         Int     @id @default(autoincrement())
  summary_id Int
  label      String
  value      Decimal @db.Decimal(19, 4)

  summary DailySummary @relation(fields: [summary_id], references: [summary_id], onDelete: Cascade)

  @@map("summary_details")
}

// ==========================================
// 8. OTHERS (Audit, Budget, Lifecycle)
// ==========================================

model Notification {
  notification_id Int      @id @default(autoincrement())
  user_id         Int
  category        String
  severity        String
  title           String
  message         String   @db.Text
  is_read         Boolean  @default(false)
  reference_table String?
  reference_id    Int?
  created_at      DateTime @default(now())

  user User @relation(fields: [user_id], references: [user_id])

  @@map("notifications")
}

model MeterLifecycleLog {
  log_id             Int      @id @default(autoincrement())
  meter_id           Int
  event_date         DateTime
  event_type         String   // INSTALL, REPLACE, REMOVE
  old_serial_num     String?
  new_serial_num     String?
  last_reading       Decimal? @db.Decimal(19, 4)
  initial_reading    Decimal? @db.Decimal(19, 4)
  evidence_image_url String?
  technician_id      Int?
  notes              String?  @db.Text
  created_at         DateTime @default(now())
  created_by         Int?

  meter      Meter @relation(fields: [meter_id], references: [meter_id])
  technician User? @relation("TechnicianAssigned", fields: [technician_id], references: [user_id])
  creator    User? @relation("LogCreatedBy", fields: [created_by], references: [user_id])

  @@map("meter_lifecycle_logs")
}

model AuditLog {
  log_id       Int      @id @default(autoincrement())
  user_id      Int
  action       String
  entity_table String
  entity_id    String
  old_values   Json?
  new_values   Json?
  reason       String?  @db.Text
  ip_address   String?
  user_agent   String?
  created_at   DateTime @default(now())

  user User @relation(fields: [user_id], references: [user_id])

  @@map("audit_logs")
}

model AnnualBudget {
  budget_id                    Int      @id @default(autoincrement())
  fiscal_year                  Int
  energy_type_id               Int
  name                         String
  total_amount                 Decimal  @db.Decimal(19, 4)
  total_volume                 Decimal  @db.Decimal(19, 4)
  efficiency_target_percentage Decimal? @db.Decimal(5, 4)
  description                  String?  @db.Text
  created_at                   DateTime @default(now())
  updated_at                   DateTime @updatedAt
  created_by                   Int?
  updated_by                   Int?

  energy_type EnergyType @relation(fields: [energy_type_id], references: [energy_type_id])
  creator     User?      @relation("BudgetCreatedBy", fields: [created_by], references: [user_id])
  updater     User?      @relation("BudgetUpdatedBy", fields: [updated_by], references: [user_id])

  allocations BudgetAllocation[]

  @@map("annual_budgets")
}

model BudgetAllocation {
  allocation_id                Int      @id @default(autoincrement())
  budget_id                    Int
  meter_id                     Int
  allocated_amount             Decimal  @db.Decimal(19, 4)
  allocated_volume             Decimal  @db.Decimal(19, 4)
  monthly_distribution_profile Json?
  created_at                   DateTime @default(now())
  updated_at                   DateTime @updatedAt

  budget AnnualBudget @relation(fields: [budget_id], references: [budget_id], onDelete: Cascade)
  meter  Meter        @relation(fields: [meter_id], references: [meter_id])

  @@map("budget_allocations")
}

model EfficiencyTarget {
  target_id         Int      @id @default(autoincrement())
  meter_id          Int
  period_start      DateTime @db.Date
  period_end        DateTime @db.Date
  kpi_name          String
  target_percentage Decimal  @db.Decimal(5, 4)
  baseline_value    Decimal  @db.Decimal(19, 4)
  created_at        DateTime @default(now())
  created_by        Int?

  meter   Meter @relation(fields: [meter_id], references: [meter_id])
  creator User? @relation("TargetCreatedBy", fields: [created_by], references: [user_id])

  @@map("efficiency_targets")
}