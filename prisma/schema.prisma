// This is your Prisma schema file.
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------
// Modul 1: Manajemen Pengguna
// ---------------------------------------------

model User {
  user_id       Int      @id @default(autoincrement())
  username      String   @unique
  password_hash String
  role_id       Int
  created_at    DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relasi
  role Role @relation(fields: [role_id], references: [role_id])

  // Relasi Balik
  reading_sessions    ReadingSession[]
  events_logbook      EventsLogbook[]
  price_schemes_set   PriceScheme[]
  efficiency_targets  EfficiencyTarget[]
  alerts_acknowledged Alert[]

  @@map("USERS")
}

model Role {
  role_id   Int      @id @default(autoincrement())
  role_name RoleName @unique

  // Relasi Balik
  users User[]

  @@map("ROLES")
}

enum RoleName {
  Teknisi
  Admin
  SuperAdmin
}

// ---------------------------------------------
// Modul 2: Data Master Aset & Energi
// ---------------------------------------------

model EnergyType {
  energy_type_id      Int      @id @default(autoincrement())
  /// Contoh: 'Listrik', 'Air', 'BBM'
  type_name           String   @unique
  /// Contoh: 'kWh', 'm3', 'Liter'
  unit_of_measurement String

  // Relasi Balik
  meters             Meter[]
  reading_types      ReadingType[]
  price_schemes      PriceScheme[]
  efficiency_targets EfficiencyTarget[]

  @@map("ENERGY_TYPES")
}

model Meter {
  meter_id         Int         @id @default(autoincrement())
  meter_code       String      @unique
  location         String?
  status           MeterStatus @default(Aktif)
  energy_type_id   Int

  // Relasi
  energy_type EnergyType @relation(fields: [energy_type_id], references: [energy_type_id])

  // Relasi Balik
  reading_sessions ReadingSession[]

  @@map("METERS")
}

enum MeterStatus {
  Aktif
  DalamPerbaikan
  Nonaktif
}

// ---------------------------------------------
// Modul 3: Pencatatan (Struktur Fleksibel)
// ---------------------------------------------

/// Tabel ini mencatat 'kapan' dan 'oleh siapa' pembacaan dilakukan.
model ReadingSession {
  session_id           Int       @id @default(autoincrement())
  timestamp            DateTime
  meter_id             Int
  user_id              Int
  /// Referensi ke session_id lain jika ini adalah koreksi
  is_correction_for_id Int?      @unique

  // Relasi (FIXED)
  user  User  @relation(fields: [user_id], references: [user_id])
  meter Meter @relation(fields: [meter_id], references: [meter_id])

  // Relasi Koreksi (Self-referencing)
  correction_for ReadingSession? @relation("CorrectionRelation", fields: [is_correction_for_id], references: [session_id])
  corrected_by   ReadingSession? @relation("CorrectionRelation")

  // Relasi Balik
  details ReadingDetail[]

  @@map("READING_SESSIONS")
}

/// Tabel ini mendefinisikan jenis-jenis pembacaan yang mungkin ada.
model ReadingType {
  reading_type_id Int    @id @default(autoincrement())
  /// Contoh: 'Main', 'WBP', 'LWBP', 'kVArh'
  type_name       String @unique
  energy_type_id  Int

  // Relasi
  energy_type EnergyType @relation(fields: [energy_type_id], references: [energy_type_id])

  // Relasi Balik
  details ReadingDetail[]

  @@map("READING_TYPES")
}

/// Tabel ini mencatat 'apa' dan 'berapa' nilai yang dibaca dalam satu sesi.
model ReadingDetail {
  detail_id       Int     @id @default(autoincrement())
  session_id      Int
  reading_type_id Int
  value           Decimal @db.Decimal(12, 2)

  // Relasi
  session      ReadingSession @relation(fields: [session_id], references: [session_id])
  reading_type ReadingType    @relation(fields: [reading_type_id], references: [reading_type_id])

  @@map("READING_DETAILS")
}

// ---------------------------------------------
// Modul 4: Operasional Lainnya
// ---------------------------------------------

model PaxData {
  pax_id    Int      @id @default(autoincrement())
  data_date DateTime @unique @db.Date
  total_pax Int

  @@map("PAX_DATA")
}

model EventsLogbook {
  event_id            Int      @id @default(autoincrement())
  event_timestamp     DateTime
  notes               String   @db.Text
  reported_by_user_id Int

  // Relasi
  reported_by User @relation(fields: [reported_by_user_id], references: [user_id])

  @@map("EVENTS_LOGBOOK")
}

// ---------------------------------------------
// Modul 5: Manajemen Harga
// ---------------------------------------------

model PriceScheme {
  scheme_id      Int      @id @default(autoincrement())
  scheme_name    String   @unique
  effective_date DateTime @db.Date
  is_active      Boolean  @default(true)
  energy_type_id Int
  set_by_user_id Int

  // Relasi
  energy_type EnergyType @relation(fields: [energy_type_id], references: [energy_type_id])
  set_by_user User       @relation(fields: [set_by_user_id], references: [user_id])

  // Relasi Balik
  rates SchemeRate[]

  @@map("PRICE_SCHEMES")
}

model SchemeRate {
  rate_id   Int      @id @default(autoincrement())
  rate_name String
  rate_type RateType
  value     Decimal  @db.Decimal(12, 4)
  scheme_id Int

  // Relasi
  scheme PriceScheme @relation(fields: [scheme_id], references: [scheme_id])

  @@map("SCHEME_RATES")
}

enum RateType {
  per_unit
  percentage
}

// ---------------------------------------------
// Modul 6: Manajemen Target & Performa
// ---------------------------------------------

model EfficiencyTarget {
  target_id      Int      @id @default(autoincrement())
  kpi_name       String
  target_value   Decimal  @db.Decimal(10, 2)
  period_start   DateTime @db.Date
  period_end     DateTime @db.Date
  energy_type_id Int
  set_by_user_id Int

  // Relasi
  energy_type EnergyType @relation(fields: [energy_type_id], references: [energy_type_id])
  set_by_user User       @relation(fields: [set_by_user_id], references: [user_id])

  // Relasi Balik
  alerts Alert[]

  @@map("EFFICIENCY_TARGETS")
}

model Alert {
  alert_id                Int         @id @default(autoincrement())
  target_id               Int
  alert_timestamp         DateTime    @default(now())
  actual_value            Decimal     @db.Decimal(12, 2)
  target_value_at_trigger Decimal     @db.Decimal(12, 2)
  status                  AlertStatus @default(BARU)
  acknowledged_by_user_id Int?

  // Relasi
  target          EfficiencyTarget @relation(fields: [target_id], references: [target_id])
  acknowledged_by User?            @relation(fields: [acknowledged_by_user_id], references: [user_id])

  @@map("ALERTS")
}

enum AlertStatus {
  BARU
  DIBACA
  DITANGANI
}

